<!DOCTYPE html>
<html lang="en">
<head>
    <title>Muat turun senarai prospek anda | Bizsaya</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#0088cc">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#0088cc">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" href="https://storage.googleapis.com/bizsaya_assets/favicon.ico" type="image/x-icon"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-center-simple.min.css" crossorigin="anonymous">
    <style>
        .container {
            margin-top: 25px;
            text-align: center;
        }

        #notification-error {
            color: red;
        }

        #notification-success {
            color: green;
        }
    </style>
</head>
<body>

<div class="container">

    <p class="lead" id="notification-error"></p>
    <p class="lead" id="notification-success"></p>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.slim.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.8.2/superagent.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/blob-util/1.2.1/blob-util.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.6.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.10.5/xlsx.min.js"></script>
<script>
  var host = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://api.bizsaya.com'

  var matches = window.location.search.match(/^\?t=(\w*)|&/)

  if (matches && matches.length <= 3) {
    window.superagent
      .get(host + '/contacts/prospects')
      .query({ token: matches[ 1 ] })
      .end((err, response) => {

        if (err) {
          $('#notification-error').text(response.body.msg)
        } else {
          var pageName = response.body.data.pagename
          var listToExcel = []

          response.body.data.prospects.map(function (p) {
            if(!_.isEmpty(p.name) && p.name.replace(/\s/g, '').length !== 0) {
              listToExcel.push({
                nama: p.name,
                nomborTelefon: p.phone,
                emel: p.email
              })
            }
          })

          if (listToExcel.length !== 0) {
            var wb = new Workbook()
            var ws = XLSX.utils.json_to_sheet(listToExcel)
            wb.SheetNames.push(pageName);
            wb.Sheets[ pageName ] = ws;
            var wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'binary' })
            saveAs(new Blob([ s2ab(wbout) ], { type: "application/octet-stream" }), "Prospek " + pageName + ".xlsx");
            $('#notification-success').text('File senarai prospek anda telah berjaya dimuat turun. Sila buka guna microsoft excel ataupun menggunakan google sheets.' +
              '\nKembali ke sistem utama Bizsaya secara automatik dalam tempoh 5 saat')
            setTimeout(() => {
              window.history.back();
            }, 5000)
          } else {
            $('#notification-error').text('Takde prospek lagi untuk page ini. Nama page : ' + pageName)
          }
        }

      })
  } else {
    $('#notification-error').text('Oppss. Token tidak dapat dijumpai. Sila mula daripada sistem Bizsaya')
  }

  function Workbook () {
    if (!(this instanceof Workbook)) return new Workbook();
    this.SheetNames = [];
    this.Sheets = {};
  }

  function s2ab (s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for (var i = 0; i != s.length; ++i) view[ i ] = s.charCodeAt(i) & 0xFF;
    return buf;
  }
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-82438198-1"></script>
<script>
  if(window.location.hostname !== 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-82438198-1');
  }
</script>
</body>
</html>